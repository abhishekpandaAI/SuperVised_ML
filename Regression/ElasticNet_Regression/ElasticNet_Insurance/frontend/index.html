<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Insurance Cost Prediction</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fb; margin: 20px; }
    .container { max-width: 1100px; margin: auto; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .card { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    label { display:block; margin:8px 0 4px; }
    input, select { width: 100%; padding: 6px; border:1px solid #ccc; border-radius:6px; }
    button { margin-top:12px; padding:10px; background:#3498db; color:white; border:none; border-radius:6px; cursor:pointer; width:100%; }
    #result { margin-top: 12px; font-weight:bold; font-size:16px; }
    canvas { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ðŸ’° Medical Insurance Cost Prediction</h1>
  <div class="container">
    <!-- Left: Form -->
    <div class="card">
      <h2>Enter Patient Details</h2>
      <form id="form">
        <label>Age<input type="number" name="age" required></label>
        <label>Sex<select name="sex"><option>male</option><option>female</option></select></label>
        <label>BMI<input type="number" step="0.1" name="bmi" required></label>
        <label>Children<input type="number" name="children" required></label>
        <label>Smoker<select name="smoker"><option>yes</option><option>no</option></select></label>
        <label>Region<select name="region">
          <option>northeast</option><option>northwest</option><option>southeast</option><option>southwest</option>
        </select></label>
        <button type="submit">Predict</button>
      </form>
      <div id="result">No prediction yet</div>
      <h3>Prediction History</h3>
      <canvas id="historyChart"></canvas>
    </div>

    <!-- Right: Model Metrics -->
    <div class="card">
      <h2>Model Metrics</h2>
      <div id="metricsText"></div>
      <h3>Feature Importance</h3>
      <canvas id="featureChart"></canvas>
    </div>
  </div>

<script>
const api="http://127.0.0.1:8000";

// --- Charts ---
const historyChart = new Chart(document.getElementById('historyChart'), {
  type: 'line',
  data: { labels: [], datasets: [{ label: "Predicted Charges", data: [], borderColor: '#3498db', fill:false }] },
  options: { responsive: true }
});

const featureChart = new Chart(document.getElementById('featureChart'), {
  type: 'bar',
  data: { labels: [], datasets: [{ label: "Coefficient", data: [], backgroundColor:'#2ecc71' }] },
  options: { indexAxis: 'y', responsive: true, plugins:{ legend:{display:false} } }
});

// --- Load metrics + feature importance ---
async function loadMetrics(){
  const r = await fetch(api+"/metrics");
  const j = await r.json();
  document.getElementById("metricsText").innerHTML = `
    <p><b>RMSE:</b> ${j.rmse.toFixed(2)}</p>
    <p><b>RÂ²:</b> ${j.r2.toFixed(4)}</p>
    <p><b>Best Params:</b> alpha=${j.best_params["elastic__alpha"]}, l1_ratio=${j.best_params["elastic__l1_ratio"]}</p>
  `;

  // Load feature importance
  const f = await fetch(api+"/feature-importance");
  const features = await f.json();
  featureChart.data.labels = features.map(x => x.feature);
  featureChart.data.datasets[0].data = features.map(x => x.coefficient);
  featureChart.update();
}
loadMetrics();

// --- Form submit ---
document.getElementById('form').onsubmit = async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  data.age=+data.age; data.bmi=+data.bmi; data.children=+data.children;

  const r=await fetch(api+"/predict",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
  const j=await r.json();

  document.getElementById("result").textContent="Predicted Charges: $"+j.predicted_charges;

  // Update history chart
  historyChart.data.labels.push(historyChart.data.labels.length+1);
  historyChart.data.datasets[0].data.push(j.predicted_charges);
  historyChart.update();
};
</script>
</body>
</html>
